<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <style>
      /* Styles for the modal */
      .modal {
          display: none; /* Hidden by default */
          position: fixed; /* Stay in place */
          z-index: 1; /* Sit on top */
          left: 0;
          top: 0;
          width: 100%; /* Full width */
          height: 100%; /* Full height */
          overflow: auto; /* Enable scroll if needed */
          background-color: rgb(0,0,0); /* Fallback color */
          background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
      }

      .modal-content {
          background-color: #fefefe;
          margin: 15% auto; /* 15% from the top and centered */
          padding: 20px;
          border: 1px solid #888;
          width: 80%; /* Could be more or less, depending on screen size */
      }

      .close {
          color: #aaa;
          float: right;
          font-size: 28px;
          font-weight: bold;
      }

      .close:hover,
      .close:focus {
          color: black;
          text-decoration: none;
          cursor: pointer;
      }
  </style>
</head>
<script
  type="module"
  src="https://unpkg.com/deep-chat@2.0.0/dist/deepChat.bundle.js"
></script>
<body>
<h1>Deep Chat</h1>

<!-- Button to open the modal -->
<button id="open-modal-button">Open Chat</button>

<!-- The Modal -->
<div id="chat-modal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <deep-chat
      id="chat-element"
      demo="true"
      textInput='{"placeholder":{"text": "Welcome to the demo!"}}'
      inputAreaStyle='{"display": "none"}'
    ></deep-chat>
  </div>
</div>

<script type="module">
  const elementRef = document.getElementById("chat-element");
  const modal = document.getElementById("chat-modal");
  const openModalButton = document.getElementById("open-modal-button");
  const closeModalButton = document.querySelector(".close");

  const generateHTML = (data) => {
    console.log('Generating HTML for data:', data);

    if (data.buttons_data) {
      const messageHtml = data.buttons_data.messages.length > 0
        ? data.buttons_data.messages.map((message) => `<p>${message.message}</p>`)
        : '<p>No messages available</p>';

      const buttonsHtml = data.buttons_data.buttons && data.buttons_data.buttons.length > 0
        ? data.buttons_data.buttons.map((button) => `<button>${button.button}</button>`)
        : '<p>No buttons available</p>';

      return `
                <div>
                    ${messageHtml}
                    ${buttonsHtml}
                </div>
            `;
    } else if (data.card_data) {
      return `
                <div>
                    ${data.card_data.cards?.map((card) => `
                        <div>
                            <h3>${card.title}</h3>
                            <p>${card.description}</p>
                            <img src="${card.image}" alt="${card.title}" />
                            ${card.buttons.map((button) => `
                                <button>${button.name}</button>
                            `)}
                        </div>
                    `)}
                </div>
            `;
    } else if (data.message_data) {
      return `
                <div>
                    ${data.message_data.messages[0] ? `<img src="${data.message_data.messages[0].message}" alt="Image" />` : '<p>No image available</p>'}
                </div>
            `;
    }
    return '<p>No data available</p>';
  };

  async function fetchNodes() {
    const chat_id = 'd290f1ee-6c54-4b01-90e6-d701748f0851'; // Replace with your actual chat_id
    const response = await fetch(`http://localhost:5000/nodes/${chat_id}`);
    const fetchedNodes = await response.json();
    let responseMessage;
    fetchedNodes.map(node => {
      if (node.data.buttons_data || node.data.card_data || node.data.type === 'image') {
        responseMessage = { html: generateHTML(node.data), role: "ai" };
      } else if (node.data.message_data) {
        responseMessage = { text: node.data.message_data.messages[0]?.message || '', role: "ai" }
      }
      elementRef.history = [...elementRef.history, responseMessage];
      console.log("history" + JSON.stringify(elementRef.history))
    })

    return responseMessage;
  }

  fetchNodes();

  // Open the modal
  openModalButton.onclick = () => {
    modal.style.display = "block";
