<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
</head>
<style>
    body {
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        background-image: url("https://media.istockphoto.com/id/1203074452/vector/space-background-with-shining-stars-nebula-and-stardust-colorful-cosmos-with-realistic.jpg?s=612x612&w=0&k=20&c=9FzjBi3qIpSomQ-pn2sLRhOQpOON1-h9YWLTzH9ThEo=");
        background-repeat: no-repeat;
        background-size: 100% 100%;
    }
    #chat-element {
        font-size: larger;
    }
    .deep-chat-next-button{
        background-color: #707EE1 !important;
    }
    .deep-chat-button-custom{
        background-color: #707EE1 !important;
    }
</style>
<script
  type="module"
  src="https://unpkg.com/deep-chat@2.0.0/dist/deepChat.bundle.js"
></script>
<body>
<div id="chat-container">
  <deep-chat
    id="chat-element"
    demo='{"displayLoadingBubble": true}'
    auxiliaryStyle="
    ::-webkit-scrollbar {
      display:none;
    }
    ::-webkit-scrollbar-thumb {
      display:none;
    }"
    textInput='{
    "disabled": true,
    "styles": {
      "container": {"height": "5vh", "width":"100%", "display":"flex","alignItems":"center", "justifyContent":"center", "borderRadius":"15px"},
      "focus": {"border": "2px solid #a2a2ff"}
    },
    "placeholder": {
      "text": "Under Construction"
  }}'
    submitButtonStyles='{
    "disabled": {
      "container": {"default": {"display":"flex","alignItems":"center", "justifyContent":"center"}},
      "svg": {
        "content": "<?xml version=\"1.0\" encoding=\"utf-8\"?> <svg viewBox=\"0 0 25 25\" xmlns=\"http://www.w3.org/2000/svg\"> <path fill-rule=\"evenodd\" d=\"M5.781 4.414a7 7 0 019.62 10.039l-9.62-10.04zm-1.408 1.42a7 7 0 009.549 9.964L4.373 5.836zM10 1a9 9 0 100 18 9 9 0 000-18z\"/> </svg>",
        "styles": {"default": {"display":"none"}}
      }
    }
  }'
    chatStyle='{"background": "rgba(204, 232, 255, 0.6)", "borderRadius": "20px","height": "80vh","width":"40vw","paddingBlock":"30px","paddingInline":"60px"}'
  ></deep-chat>
</div>
</body>
<script type="module">
  function getMaxWidth() {
    const screenWidth = window.innerWidth;
    if (screenWidth <= 1024) {
      return "90%"; // Mobile size
    }
     else {
      return "50%"; // Desktop size
    }
  }
  const messageStyles = {


    "loading": {
    "bubble": {"backgroundColor": "unset","color": "#3793ff", "fontSize": "20px"}
  },
    "default": {
    "shared": {"innerContainer": {"margin": "0px", "width":"100%"},"bubble": {"color": "#202A5E", "maxWidth":getMaxWidth()}},
    "ai": {"bubble": {"backgroundColor": "unset",
      "border-top-left-radius": "10px",
      "border-bottom-left-radius": "10px",
      "border-top-right-radius": "10px",
      "border-bottom-right-radius": "10px"}},
    "user": {"bubble": {"backgroundColor": "#707EE1", "color":"white", "padding-inline":"3vh", "padding-block":"1vh",
      "border-top-left-radius": "10px",
      "border-bottom-left-radius": "10px",
      "border-top-right-radius": "10px",
      "border-bottom-right-radius": "10px"}},
    "bob": {"bubble": {"backgroundColor": "white"}}
  }
  };


  const elementRef = document.getElementById("chat-element");
  elementRef.messageStyles = messageStyles;
  const chatContainer = document.getElementById("chat-container");

  let currentNodeIndex = 0;
  let fetchedNodes = [];

  document.addEventListener("click", (event) => {
    // Check if the click was outside the chat element
    if (!chatContainer.contains(event.target)) {
      elementRef.style.display = "none";
    }
  });

  const generateHTML = (data) => {

    if (data.buttons_data) {
      const buttonsHtml = data.buttons_data.buttons && data.buttons_data.buttons.length > 0
        ? data.buttons_data.buttons.map((button) => `<button class="deep-chat-button-custom" style="margin-inline:4px; background-color: #707EE1 !important; padding-inline: 20px;
    padding-block: 10px; border-radius: 10px; border:0; color:white" onclick="handleButtonClick('${button.button}')">${button.button}</button>`).join('')
        : '<p>No buttons available</p>';

      return `
                <div>
                    ${buttonsHtml}
                </div>
            `;
    } else if (data.card_data) {
      return `
                <div>
                    ${data.card_data.cards?.map((card) => `
                        <div>
                            ${card.buttons.map((button) => `
                                <button class="deep-chat-button-custom"  style="margin-inline:2px; background-color: #707EE1 !important; padding-inline: 20px;
    padding-block: 10px; border-radius: 10px; border:0; color:white" onclick="handleButtonClick('${button.name}')">${button.name}</button>
                            `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
    }
    else if (data.message_data) {
     const imageHtml = data.message_data.messages
        .filter(message => message.type === 'image')
        .map(message => `<img src="${message.message}" alt="Image" style="padding-bottom: 2px;max-width: 100%; border-radius: 10px" />`)
        .join('');

      return `
                <div>
                    ${imageHtml ? imageHtml : '<p>No image available</p>'}
                </div>
            `;
    }
    return '<p>No data available</p>';
  };
  const generateText = (data) => {

    if (data.buttons_data) {
      const messageHtml = data.buttons_data.messages.length > 0
        ? data.buttons_data.messages.map((message) => `<div style="background-color: white; padding-inline: 20px;
    padding-block: 10px; border-radius: 10px">${message.message}</div>`).join('')
        : '<p>No messages available</p>';

      return `
                <div>
                    ${messageHtml}
                </div>
            `;
    } else if (data.card_data) {
      return `
                <div style="background-color: white; padding-inline: 20px;
    padding-block: 10px; border-radius: 10px">
                    ${data.card_data.cards?.map((card) => `
                        <div>
                            <h3>${card.title}</h3>
                            <p>${card.description}</p>
                            <img src="${card.image}" alt="${card.title}" style="width:90%; border-radius: 10px; margin-bottom: 1vh"/>
                        </div>
                    `).join('')}
                </div>
            `;
    }
    else if (data.message_data) {
      const textHtml = data.message_data.messages
        .filter(message => message.type === 'text')
        .map(message => `<div style="background-color: white; padding-inline: 20px;
    padding-block: 10px; border-radius: 10px">${message.message}</div>`)
        .join('');

      return `
                <div>
                    ${textHtml ? textHtml : '<p>No text available</p>'}
                </div>
            `;
    }
    return '<p>No data available</p>';
  };
  async function fetchNodes() {
    const chat_id = 'd290f1ee-6c54-4b01-90e6-d701748f0851'; // Replace with your actual chat_id
   // const response = await fetch(`https://deep-chat-1.onrender.com/nodes/${chat_id}`);
    const response = await fetch(`https://deep-chat-1.onrender.com/nodes/${chat_id}`);
    fetchedNodes = await response.json();
    displayNode(currentNodeIndex);
  }

  function displayNode(index) {
    if (index < fetchedNodes.length) {
      const node = fetchedNodes[index];
      const responseHTML = { html: generateHTML(node.data), role: "ai" };
      const responseMessage = { html: generateText(node.data), role: "ai" };

      elementRef.history = [...elementRef.history, responseMessage, responseHTML,];

      if (!(node.data.buttons_data && node.data.buttons_data.buttons.length > 0)) {
        // Add a "Next" button if there are no buttons in the node
        const nextButtonHtml = `<div class="deep-chat-next-button" onclick="handleNextButtonClick()">Next</div>`;
        const nextButtonMessage = { html: nextButtonHtml, role: "user" };
        elementRef.history = [...elementRef.history, nextButtonMessage];
      }
    }
  }

  function handleButtonClick(buttonText) {
    elementRef.history = [...elementRef.history, { role: "user", text: buttonText }];
    currentNodeIndex++;
    displayNode(currentNodeIndex);
  }

  function handleNextButtonClick() {
    currentNodeIndex++;
    displayNode(currentNodeIndex);
  }

  window.handleButtonClick = handleButtonClick;
  window.handleNextButtonClick = handleNextButtonClick;

  document.addEventListener('DOMContentLoaded', () => {
    fetchNodes();
  });

  elementRef.history = [
    { role: "ai", html: `<div style="background-color: white; padding-inline: 20px;
    padding-block: 10px; border-radius: 10px">Do you want to know more about our product?` }
  ];
  // elementRef.setAttribute(
  //   "introMessage",
  //   JSON.stringify({
  //     text: "Hi! I am your AI assistant..",
  //   })
  // );
</script>
</html>
